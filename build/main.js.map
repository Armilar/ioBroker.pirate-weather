{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/*\n * Created with @iobroker/create-adapter v2.6.5\n */\n\n// The adapter-core module gives you access to the core ioBroker functions\n// you need to create an adapter\nimport * as utils from '@iobroker/adapter-core';\nimport axios from 'axios';\nimport 'source-map-support/register';\nimport {Library} from './lib/library';\nimport {genericStateObjects} from './lib/definition';\n\n// Load your modules here, e.g.:\n// import * as fs from \"fs\";\n\nclass PirateWeather extends utils.Adapter {\n    library: Library;\n    unload: boolean = false;\n    getWeatherLoopTimeout: ioBroker.Timeout | undefined | null = null;\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\n        super({\n            ...options,\n            name: 'pirate-weather',\n        });\n        this.on('ready', this.onReady.bind(this));\n        // this.on('stateChange', this.onStateChange.bind(this));\n        // this.on('objectChange', this.onObjectChange.bind(this));\n        // this.on('message', this.onMessage.bind(this));\n        this.on('unload', this.onUnload.bind(this));\n        this.library = new Library(this, 'PirateWeather');\n    }\n\n    /**\n     * Is called when databases are connected and adapter received configuration.\n     */\n    private async onReady (): Promise<void> {\n        if (this.config.pollInterval < 1) {\n            this.log.warn(`Invalid poll interval: ${this.config.pollInterval}. Using default value of 1 hour.`);\n            this.config.pollInterval = 1; // Default to 1 minute if invalid\n        }\n        if (!this.config.apiToken) {\n            this.log.error('API token is not set in the adapter configuration. Please set it in the adapter settings.');\n            return;\n        }\n        if (!this.config.position || typeof this.config.position !== 'string' || !this.config.position.split(',').every(coord => !isNaN(parseFloat(coord)))) {\n            this.log.error('Position is not set in the adapter configuration. Please set it in the adapter settings.');\n            return;\n        }\n        await this.library.init();\n        const states = await this.getStatesAsync('*');\n        await this.library.initStates(states);\n        this.getPirateWeatherLoop();\n    }\n\n    getPirateWeatherLoop = async (): Promise<void> => {\n        try {\n            if (this.getWeatherLoopTimeout) {\n                this.clearTimeout(this.getWeatherLoopTimeout);\n            }\n            await this.getData();\n        } catch (error) {\n            this.log.error(`Error in getPirateWeatherLoop: ${error}`);\n        } finally {\n            const loopTime = new Date().setHours(new Date().getHours() + this.config.pollInterval) + 100 + Math.floor(Math.random() * 3000); // Add a random delay of up to 3 second\n            this.getWeatherLoopTimeout = this.setTimeout(() => {\n                this.getPirateWeatherLoop();\n            }, loopTime - Date.now());\n        }\n    }\n\n    getData = async (): Promise<void> => {\n        try {\n            const result = await axios.get(`https://api.pirateweather.net/forecast/${this.config.apiToken}/${this.config.position}?units=${this.config.units || 'si'}`);\n            if (result.status === 200) {\n                this.log.debug(`Data fetched successfully: ${JSON.stringify(result.data)}`);\n                result.data.units = result.data.flags.units;\n                result.data['nearest-station'] = result.data.flags['nearest-station'];\n                result.data.version = result.data.flags.version;\n                delete result.data.flags;\n                await this.library.writeFromJson('weather', '', genericStateObjects, result.data, true);\n            }\n        } catch (error) {\n            this.log.error(`Error fetching data from Pirate Weather API: ${error}`);\n        }\n    };\n\n\n    /**\n     * Is called when adapter shuts down - callback has to be called under any circumstances!\n     *\n     * @param callback\n     */\n    private onUnload (callback: () => void): void {\n        try {\n            // Here you must clear all timeouts or intervals that may still be active\n            // clearTimeout(timeout1);\n            // clearTimeout(timeout2);\n            // ...\n            // clearInterval(interval1);\n\n            callback();\n        } catch {\n            callback();\n        }\n    }\n\n}\n\nif (require.main !== module) {\n    // Export the constructor in compact mode\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new PirateWeather(options);\n} else {\n    // otherwise start the instance directly\n    (() => new PirateWeather())();\n}\n"],
  "mappings": "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",
  "names": ["axios"]
}
